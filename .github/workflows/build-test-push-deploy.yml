name: Build/Test/Push + Bump GitOps

on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string
      jfrog_registry:
        required: true
        type: string
      jfrog_docker_repo:
        required: true
        type: string
      gitops_repo:
        required: true
        type: string
      gitops_values_dev_path:
        required: true
        type: string
      gitops_values_test_path:
        required: true
        type: string
      app_port:
        required: false
        type: number
        default: 3000
    secrets:
      JFROG_USERNAME:
        required: true
      JFROG_TOKEN:
        required: true
      GITOPS_TOKEN:
        required: true

concurrency:
  group: reusable-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      short_sha: ${{ steps.vars.outputs.short_sha }}
      full_tag: ${{ steps.meta.outputs.full_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Infer short sha
        id: vars
        shell: bash
        run: echo "short_sha=${GITHUB_SHA:0:8}" >> $GITHUB_OUTPUT

      - name: Build image
        run: docker build -t "${{ inputs.image_name }}:ci" .

      - name: Save image artifact
        run: docker save "${{ inputs.image_name }}:ci" | gzip > image-ci.tar.gz

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-ci
          path: image-ci.tar.gz
          retention-days: 1

      - name: Compute full tag
        id: meta
        shell: bash
        run: |
          SHORT_SHA="${{ steps.vars.outputs.short_sha }}"
          FULL_TAG="${{ inputs.jfrog_registry }}/${{ inputs.jfrog_docker_repo }}/${{ inputs.image_name }}:docker-${SHORT_SHA}"
          echo "full_tag=$FULL_TAG" >> $GITHUB_OUTPUT

  smoke_test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-ci

      - name: Load image
        run: gunzip -c image-ci.tar.gz | docker load

      - name: Smoke test (docker compose, JSON only)
        shell: bash
        run: |
          # Force compose to use prebuilt image:
          cat > docker-compose.ci.override.yml <<'YAML'
          services:
            app:
              image: ${{ inputs.image_name }}:ci
          YAML

          docker compose --env-file env/dev.env \
            -f docker-compose.yml -f docker-compose.dev.yml -f docker-compose.ci.override.yml \
            up -d --no-build

          echo "Waiting for app..."
          for i in {1..40}; do
            if curl -sSf "http://localhost:${{ inputs.app_port }}/" >/dev/null; then
              echo "App responding."
              break
            fi
            sleep 3
          done

          curl -sSf "http://localhost:${{ inputs.app_port }}/" -o /tmp/resp.json
          python -m json.tool /tmp/resp.json >/dev/null
          echo "Smoke test OK"

      - name: Logs on failure
        if: failure()
        run: |
          docker compose ps
          docker compose logs --no-color

      - name: Cleanup
        if: always()
        run: docker compose down -v

  push_and_bump:
    runs-on: ubuntu-latest
    needs: [build, smoke_test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-ci

      - name: Load image
        run: gunzip -c image-ci.tar.gz | docker load

      - name: Login & Push to JFrog
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ secrets.JFROG_TOKEN }}" | docker login "${{ inputs.jfrog_registry }}" \
            -u "${{ secrets.JFROG_USERNAME }}" --password-stdin

          FULL_TAG="${{ needs.build.outputs.full_tag }}"
          echo "Pushing $FULL_TAG"

          docker tag "${{ inputs.image_name }}:ci" "$FULL_TAG"
          docker push "$FULL_TAG"

      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.gitops_repo }}
          token: ${{ secrets.GITOPS_TOKEN }}
          ref: main
          path: gitops
          fetch-depth: 0

      - name: Bump dev & test image tag in GitOps values
        shell: bash
        run: |
          set -euo pipefail
          SHORT_SHA="${{ needs.build.outputs.short_sha }}"
          DEV_FILE="gitops/${{ inputs.gitops_values_dev_path }}"
          TEST_FILE="gitops/${{ inputs.gitops_values_test_path }}"

          for FILE in "$DEV_FILE" "$TEST_FILE"; do
            [[ -f "$FILE" ]] || { echo "Missing: $FILE"; exit 1; }

            # require tag: to exist
            grep -qE '^[[:space:]]*tag:[[:space:]]*' "$FILE" \
              || { echo "No tag: found in $FILE"; exit 1; }

            sed -i -E "s|^([[:space:]]*tag:[[:space:]]*).*$|\1\"docker-${SHORT_SHA}\"|g" "$FILE"
            grep -qE "^[[:space:]]*tag:[[:space:]]*\"docker-${SHORT_SHA}\"" "$FILE" \
              || { echo "Failed to set tag in $FILE"; exit 1; }
          done

          git -C gitops diff -- .

      - name: Create PR in GitOps repo
        shell: bash
        run: |
          set -euo pipefail
          SHORT_SHA="${{ needs.build.outputs.short_sha }}"
          BRANCH="bump/dev-test-docker-${SHORT_SHA}"

          cd gitops
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add "${{ inputs.gitops_values_dev_path }}" "${{ inputs.gitops_values_test_path }}"
          git commit -m "chore(deploy): bump dev/test image tag to docker-${SHORT_SHA}"
          git push origin "$BRANCH"

          # Create PR via GitHub API (no extra action needed)
          api_url="https://api.github.com/repos/${{ inputs.gitops_repo }}/pulls"
          body=$(jq -n \
            --arg title "chore(deploy): bump dev/test to docker-${SHORT_SHA}" \
            --arg head "$BRANCH" \
            --arg base "main" \
            --arg msg "Auto-generated by CI after image push: docker-${SHORT_SHA}" \
            '{title:$title, head:$head, base:$base, body:$msg}')

          curl -sSf -X POST \
            -H "Authorization: token ${{ secrets.GITOPS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "$api_url" \
            -d "$body" | jq -r '.html_url'
