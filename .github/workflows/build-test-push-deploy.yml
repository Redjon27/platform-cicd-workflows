name: Build/Test/Push + GitOps PR (dev only)

on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string
      jfrog_registry:
        required: true
        type: string
      jfrog_docker_repo:
        required: true
        type: string

      gitops_repo:
        required: true
        type: string
      gitops_values_dev_path:
        required: true
        type: string

      app_port:
        required: false
        type: number
        default: 3000

    secrets:
      JFROG_USERNAME:
        required: true
      JFROG_TOKEN:
        required: true
      GITOPS_TOKEN:
        required: true

concurrency:
  group: reusable-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      short_sha: ${{ steps.vars.outputs.short_sha }}
      full_tag: ${{ steps.meta.outputs.full_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Infer short sha
        id: vars
        shell: bash
        run: echo "short_sha=${GITHUB_SHA:0:8}" >> $GITHUB_OUTPUT

      - name: Build image
        shell: bash
        run: docker build -t "${{ inputs.image_name }}:ci" .

      - name: Save image artifact
        shell: bash
        run: docker save "${{ inputs.image_name }}:ci" | gzip > image-ci.tar.gz

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-ci
          path: image-ci.tar.gz
          retention-days: 1

      - name: Compute full tag
        id: meta
        shell: bash
        run: |
          SHORT_SHA="${{ steps.vars.outputs.short_sha }}"
          FULL_TAG="${{ inputs.jfrog_registry }}/${{ inputs.jfrog_docker_repo }}/${{ inputs.image_name }}:docker-${SHORT_SHA}"
          echo "full_tag=$FULL_TAG" >> $GITHUB_OUTPUT

  smoke_test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-ci

      - name: Load image
        shell: bash
        run: gunzip -c image-ci.tar.gz | docker load

      - name: Smoke test (docker compose, JSON only)
        shell: bash
        run: |
          cat > docker-compose.ci.override.yml <<'YAML'
          services:
            app:
              image: ${{ inputs.image_name }}:ci
          YAML

          docker compose --env-file env/dev.env \
            -f docker-compose.yml -f docker-compose.dev.yml -f docker-compose.ci.override.yml \
            up -d --no-build

          echo "Waiting for app..."
          for i in {1..40}; do
            if curl -sSf "http://localhost:${{ inputs.app_port }}/" >/dev/null; then
              echo "App responding."
              break
            fi
            sleep 3
          done

          curl -sSf "http://localhost:${{ inputs.app_port }}/" -o /tmp/resp.json
          python -m json.tool /tmp/resp.json >/dev/null
          echo "Smoke test OK"

      - name: Logs on failure
        if: failure()
        shell: bash
        run: |
          docker compose ps
          docker compose logs --no-color

      - name: Cleanup
        if: always()
        shell: bash
        run: docker compose down -v

  push_and_pr_dev:
    runs-on: ubuntu-latest
    needs: [build, smoke_test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      pr_url: ${{ steps.create_pr.outputs.pr_url }}
      pr_number: ${{ steps.create_pr.outputs.pr_number }}
    steps:
      - name: Install tools (jq + pinned yq v4)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq curl
          YQ_VERSION="v4.45.1"
          sudo curl -sSL -o /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq
          echo "Using yq:"
          which yq
          yq --version

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-ci

      - name: Load image
        shell: bash
        run: gunzip -c image-ci.tar.gz | docker load

      - name: Login & Push to JFrog
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ secrets.JFROG_TOKEN }}" | docker login "${{ inputs.jfrog_registry }}" \
            -u "${{ secrets.JFROG_USERNAME }}" --password-stdin

          FULL_TAG="${{ needs.build.outputs.full_tag }}"
          docker tag "${{ inputs.image_name }}:ci" "$FULL_TAG"
          docker push "$FULL_TAG"
          echo "Pushed $FULL_TAG"

      - name: Checkout GitOps repo (repo #4)
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.gitops_repo }}
          token: ${{ secrets.GITOPS_TOKEN }}
          ref: main
          path: gitops
          fetch-depth: 0

      - name: Bump DEV image tag in GitOps values
        shell: bash
        env:
          SHORT_SHA: ${{ needs.build.outputs.short_sha }}
        run: |
          set -euo pipefail
          DEV_FILE="gitops/${{ inputs.gitops_values_dev_path }}"
          [[ -f "$DEV_FILE" ]] || { echo "Missing: $DEV_FILE"; exit 1; }

          # Update only the nested key (wrapper dependency values)
          # Key has '-' so we use bracket notation:
          yq e -i '.["devops-tech-challenge"].app.image.tag = "docker-" + strenv(SHORT_SHA)' "$DEV_FILE"

          # Sanity check
          yq e -e '.["devops-tech-challenge"].app.image.tag == ("docker-" + strenv(SHORT_SHA))' "$DEV_FILE" >/dev/null

          git -C gitops diff -- .

      - name: Create PR in GitOps repo (dev only)
        id: create_pr
        shell: bash
        run: |
          set -euo pipefail
          SHORT_SHA="${{ needs.build.outputs.short_sha }}"
          BRANCH="bump/dev-docker-${SHORT_SHA}"

          cd gitops
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add "${{ inputs.gitops_values_dev_path }}"

          if git diff --cached --quiet; then
            echo "No changes detected. Skipping PR."
            echo "pr_url=" >> $GITHUB_OUTPUT
            echo "pr_number=" >> $GITHUB_OUTPUT
            exit 0
          fi

          git commit -m "chore(deploy): bump dev image tag to docker-${SHORT_SHA}"
          git push -u origin "$BRANCH"

          api_url="https://api.github.com/repos/${{ inputs.gitops_repo }}/pulls"
          payload=$(jq -n \
            --arg title "chore(dev): bump image tag to docker-${SHORT_SHA}" \
            --arg head "$BRANCH" \
            --arg base "main" \
            --arg body "Auto-generated PR after pushing image docker-${SHORT_SHA}. (Dev auto-promotion only)" \
            '{title:$title, head:$head, base:$base, body:$body}')

          resp=$(curl -sS -X POST \
            -H "Authorization: Bearer ${{ secrets.GITOPS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "$api_url" \
            -d "$payload" || true)

          pr_url=$(echo "$resp" | jq -r '.html_url // empty')
          pr_number=$(echo "$resp" | jq -r '.number // empty')

          if [[ -n "$pr_url" && -n "$pr_number" ]]; then
            echo "PR created: $pr_url"
            echo "pr_url=$pr_url" >> $GITHUB_OUTPUT
            echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "PR not created. Response:"
          echo "$resp" | jq -r '.' || echo "$resp"
          exit 1

  auto_approve_and_merge:
    runs-on: ubuntu-latest
    needs: push_and_pr_dev
    if: ${{ needs.push_and_pr_dev.outputs.pr_number != '' }}
    steps:
      - name: Approve PR
        shell: bash
        run: |
          set -euo pipefail
          PR_NUMBER="${{ needs.push_and_pr_dev.outputs.pr_number }}"

          curl -sSf -X POST \
            -H "Authorization: Bearer ${{ secrets.GITOPS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ inputs.gitops_repo }}/pulls/${PR_NUMBER}/reviews" \
            -d '{"event":"APPROVE","body":"Auto-approve: dev promotion"}' >/dev/null

          echo "Approved PR #${PR_NUMBER}"

      - name: Merge PR (squash)
        shell: bash
        run: |
          set -euo pipefail
          PR_NUMBER="${{ needs.push_and_pr_dev.outputs.pr_number }}"

          curl -sSf -X PUT \
            -H "Authorization: Bearer ${{ secrets.GITOPS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ inputs.gitops_repo }}/pulls/${PR_NUMBER}/merge" \
            -d '{"merge_method":"squash","commit_title":"chore(dev): auto-merge image bump"}' >/dev/null

          echo "Merged PR #${PR_NUMBER}"
